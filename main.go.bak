package main

import (
	"context"
	"encoding/json"
	"fmt"
	"log"

	lark "github.com/larksuite/oapi-sdk-go/v3"
	larkcore "github.com/larksuite/oapi-sdk-go/v3/core"
	"github.com/larksuite/oapi-sdk-go/v3/event/dispatcher"
	larkim "github.com/larksuite/oapi-sdk-go/v3/service/im/v1"
)

// é…ç½®ä¿¡æ¯
const (
	APP_ID     = "cli_a9f1dae58d39dcd6"     // æ›¿æ¢ä¸ºæ‚¨çš„ App ID
	APP_SECRET = "wKp9u9Ys2YhtaPSotuOoheIdPBJFp0za" // æ›¿æ¢ä¸ºæ‚¨çš„ App Secret
)

func main() {
	// åˆ›å»ºé£ä¹¦å®¢æˆ·ç«¯
	client := lark.NewClient(APP_ID, APP_SECRET)

	// æ³¨å†Œæ¶ˆæ¯æ¥æ”¶äº‹ä»¶å¤„ç†å™¨
	handler := dispatcher.NewEventDispatcher("", "").
		OnP2ImMessageReceiveV1(func(ctx context.Context, event *larkim.P2ImMessageReceiveV1) error {
			// è·å–æ¶ˆæ¯ä¿¡æ¯
			msg := event.Event.Message
			if msg == nil || msg.Content == nil {
				return nil
			}

			content := *msg.Content
			messageId := *msg.MessageId

			log.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
			log.Printf("ğŸ’¬ æ”¶åˆ°æ–°æ¶ˆæ¯: ID=%s", messageId)
			log.Printf("   åŸå§‹å†…å®¹: %s", content)

			// è§£ææ–‡æœ¬æ¶ˆæ¯
			var contentMap map[string]interface{}
			if err := json.Unmarshal([]byte(content), &contentMap); err == nil {
				if text, ok := contentMap["text"].(string); ok {
					log.Printf("   æ–‡æœ¬: %s", text)

					// è‡ªåŠ¨å›å¤
					replyText := fmt.Sprintf("æ”¶åˆ°ï¼š%s", text)
					replyMsg(ctx, client, messageId, replyText)
				}
			}
			log.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")

			return nil
		})

	log.Println("ğŸš€ å¯åŠ¨é£ä¹¦é•¿é“¾æ¥ç›‘å¬...")

	// ä½¿ç”¨é•¿é“¾æ¥æ–¹å¼
	cli := lark.NewClient(APP_ID, APP_SECRET,
		lark.WithLogLevel(larkcore.LogLevelInfo),
		lark.WithEventHandler(handler),
	)

	// å¯åŠ¨é•¿é“¾æ¥ - é˜»å¡è¿è¡Œ
	log.Println("âœ… é•¿é“¾æ¥å·²å»ºç«‹ï¼Œç­‰å¾…äº‹ä»¶...")
	log.Println("ğŸ“ ç›‘å¬äº‹ä»¶: im.message.receive_v1")
	log.Println("æç¤º: æŒ‰ Ctrl+C é€€å‡º")
	log.Println("")

	// è¿™é‡Œéœ€è¦ä¿æŒç¨‹åºè¿è¡Œ
	select {}
}

// å›å¤æ¶ˆæ¯
func replyMsg(ctx context.Context, client *lark.Client, msgId, text string) {
	req := larkim.NewReplyMessageReqBuilder().
		MessageId(msgId).
		Body(larkim.NewReplyMessageReqBodyBuilder().
			MsgType("text").
			Content(fmt.Sprintf(`{"text":"%s"}`, text)).
			Build()).
		Build()

	resp, err := client.Im.Message.Reply(ctx, req)
	if err != nil {
		log.Printf("âŒ å›å¤å¤±è´¥: %v", err)
		return
	}

	if resp.Success() {
		log.Printf("âœ… å·²å›å¤: %s", text)
	} else {
		log.Printf("âŒ å›å¤å¤±è´¥: %s", resp.Msg)
	}
}
